<script>
    const ADMIN_PASSWORD = "yash@999";
    const POSTS_JSON_URL = "posts.json"; // URL to the centralized post list
    const addPostBtn = document.getElementById("addPostBtn");
    const adminLoginBtn = document.getElementById("adminLoginBtn");
    const adminLogoutBtn = document.getElementById("adminLogoutBtn");
    const searchInput = document.getElementById("searchInput");
    const container = document.getElementById("posts-container");

    let allPosts = []; // Global variable to store all loaded posts

    function isAdmin() {
      return localStorage.getItem("isAdmin") === "true";
    }

    function updateAdminUI() {
      if (isAdmin()) {
        addPostBtn.style.display = "inline-block";
        adminLoginBtn.style.display = "none";
        adminLogoutBtn.style.display = "inline-block";
      } else {
        addPostBtn.style.display = "none";
        adminLoginBtn.style.display = "inline-block";
        adminLogoutBtn.style.display = "none";
      }
      filterPosts();
    }

    adminLoginBtn.onclick = () => {
      const input = prompt("Enter admin password:");
      if (input === ADMIN_PASSWORD) {
        localStorage.setItem("isAdmin", "true");
        alert("Admin mode enabled.");
        updateAdminUI();
      } else if (input !== null) {
        alert("Incorrect password.");
      }
    };

    adminLogoutBtn.onclick = () => {
      localStorage.removeItem("isAdmin");
      alert("Logged out from admin mode.");
      updateAdminUI();
    };

    async function loadPosts() {
      try {
        // Fetch posts from the centralized JSON file
        const response = await fetch(POSTS_JSON_URL);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const jsonPosts = await response.json();
        
        // Load custom posts from local storage (for posts added since last JSON update)
        const customPosts = JSON.parse(localStorage.getItem("customPosts") || "[]");
        
        // Combine them, ensuring custom posts (newer) appear before the JSON posts
        allPosts = [...customPosts, ...jsonPosts.filter(p => !customPosts.some(cp => cp.id === p.id))];
        
        return allPosts;

      } catch (error) {
        console.error("Could not fetch or parse JSON posts:", error);
        // Fallback: If JSON fails, only load posts from local storage
        allPosts = JSON.parse(localStorage.getItem("customPosts") || "[]");
        return allPosts;
      }
    }

    function renderPosts(list) {
      container.innerHTML = "";
      if (list.length === 0) {
        container.innerHTML = "<p class='text-center text-muted'>No posts found.</p>";
        return;
      }

      const admin = isAdmin();
      const customPosts = JSON.parse(localStorage.getItem("customPosts") || "[]");

      list.forEach((post) => {
        const col = document.createElement("div");
        col.className = "col-6 col-md-4 col-lg-3 d-flex";

        const card = document.createElement("div");
        card.className = "card shadow-sm";

        // Check if the post is a 'custom post' to display admin controls
        const isCustomPost = customPosts.some((p) => p.id === post.id);

        card.innerHTML = `
          <img src="${post.poster}" class="poster-img" alt="Poster" />
          <div class="card-body">
            <h5 class="card-title">${post.heading}</h5>
          </div>
          ${
            admin && isCustomPost
              ? `<div class="admin-controls">
              <button class="btn btn-sm btn-outline-warning btn-edit" title="Edit">‚úèÔ∏è</button>
              <button class="btn btn-sm btn-outline-danger btn-delete" title="Delete">üóëÔ∏è</button>
            </div>`
              : ``
          }
        `;

        card.onclick = (e) => {
          if (!e.target.classList.contains("btn-edit") && !e.target.classList.contains("btn-delete")) {
            window.open(`post.html?id=${post.id}`, "_blank");
          }
        };

        col.appendChild(card);
        container.appendChild(col);

        if (admin && isCustomPost) {
          const editBtn = card.querySelector(".btn-edit");
          const deleteBtn = card.querySelector(".btn-delete");

          editBtn.onclick = (e) => {
            e.stopPropagation();
            editPost(post.id);
          };

          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deletePost(post.id);
          };
        }
      });
    }

    function editPost(id) {
      // Find post in local storage
      let customPosts = JSON.parse(localStorage.getItem("customPosts") || "[]");
      const post = customPosts.find((p) => p.id === id);
      if (!post) return alert("Cannot edit this post. It might be from the central JSON.");

      const newHeading = prompt("Edit heading:", post.heading);
      if (newHeading === null) return;

      const newPoster = prompt("Edit poster URL:", post.poster);
      if (newPoster === null) return;

      const newVideoUrl = prompt("Edit video URL:", post.videoUrl);
      if (newVideoUrl === null) return;

      post.heading = newHeading.trim() || post.heading;
      post.poster = newPoster.trim() || post.poster;
      post.videoUrl = newVideoUrl.trim() || post.videoUrl;

      localStorage.setItem("customPosts", JSON.stringify(customPosts));
      updateAdminUI();
      alert("Post updated.");
    }

    function deletePost(id) {
      if (!confirm("Are you sure you want to delete this post?")) return;
      let customPosts = JSON.parse(localStorage.getItem("customPosts") || "[]");
      const index = customPosts.findIndex((p) => p.id === id);
      if (index === -1) return alert("Cannot delete this post. It might be from the central JSON.");

      customPosts.splice(index, 1);
      localStorage.setItem("customPosts", JSON.stringify(customPosts));
      updateAdminUI();
      alert("Post deleted.");
    }

    async function filterPosts() {
      await loadPosts(); // Ensure posts are loaded before filtering
      const query = searchInput.value.toLowerCase();
      const filtered = allPosts.filter((p) => p.heading.toLowerCase().includes(query));
      filtered.sort((a, b) => b.id - a.id);
      renderPosts(filtered);
    }

    searchInput.oninput = filterPosts;

    window.addEventListener("storage", (event) => {
      if (event.key === "customPosts") {
        filterPosts();
      }
    });

    updateAdminUI();
    filterPosts(); // Initial load
  </script>