<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yash - Movie Gallery</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f0f4f8; }
    .card { transition: transform 0.3s, box-shadow 0.3s; border-radius: 16px; overflow: hidden; cursor: pointer; height: 100%; display: flex; flex-direction: column; }
    .card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
    .poster-img { width: 100%; height: 200px; object-fit: cover; }
    .card-body { padding: 10px; flex-grow: 1; }
    footer { background: linear-gradient(to right, #4a90e2, #50e3c2); color: #fff; text-align: center; padding: 20px; margin-top: 50px; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
    <div class="container">
      <a class="navbar-brand fs-4" href="#">Yash's Movie Collection</a>
    </div>
  </nav>

  <div class="container py-4">
    <input type="text" id="searchInput" class="form-control mb-3" placeholder="Search by Movie..." />
    <div class="row g-3" id="posts-container"></div>
  </div>

  <footer>
    <div class="container">
      <p class="mb-0">© 2025 My Collection. Data provided by YASH.</p>
    </div>
  </footer>

  <script>
    const OMDB_KEY = "1f818a3f";
    const POSTS_JSON_URL = "posts.json";
    const searchInput = document.getElementById("searchInput");
    const container = document.getElementById("posts-container");
    let allPosts = [];
    const omdbCache = {};

    async function fetchOMDbDetails(title) {
      if (!title) return null;
      if (omdbCache[title]) return omdbCache[title];
      
      try {
        const res = await fetch(`https://www.omdbapi.com/?apikey=${OMDB_KEY}&t=${encodeURIComponent(title)}`);
        const data = await res.json();
        if (data.Response === "True") {
          omdbCache[title] = data;
          return data;
        }
      } catch (err) { 
        console.error('OMDb fetch error:', err); 
      }
      return null;
    }

    async function loadPosts() {
      try {
        const response = await fetch(POSTS_JSON_URL);
        const jsonPosts = await response.json();
        const cleaned = jsonPosts.filter(p => p.heading).map(p => ({...p, id: parseInt(p.id)}));
        return cleaned;
      } catch (e) {
        console.error("Error loading posts.json", e);
        return [];
      }
    }

    function createCard(post) {
      const col = document.createElement("div");
      col.className = "col-6 col-md-4 col-lg-3 d-flex";
      col.id = `card-${post.id}`;
      
      const card = document.createElement("div");
      card.className = "card shadow-sm";
      
      // Use JSON poster first (your URL)
      card.innerHTML = `
        <img src="${post.poster}" class="poster-img" alt="Poster" onerror="this.src='https://via.placeholder.com/200x300?text=No+Image'" />
        <div class="card-body">
          <h6 class="card-title">${post.heading}</h6>
          <p class="text-muted mb-0" id="rating-${post.id}"></p>
        </div>`;
      
      card.onclick = () => window.open(`post.html?id=${post.id}`, "_blank");
      col.appendChild(card);
      return col;
    }

    async function updateCardWithOMDb(post) {
      const omdb = await fetchOMDbDetails(post.heading);
      const ratingEl = document.getElementById(`rating-${post.id}`);
      
      if (omdb) {
        // Only update rating, keep JSON poster
        const rating = omdb.imdbRating !== "N/A" ? `⭐ ${omdb.imdbRating}/10` : "";
        if (ratingEl) ratingEl.textContent = rating;
        
        // Use OMDb poster ONLY as fallback if JSON poster fails to load
        const cardEl = document.getElementById(`card-${post.id}`);
        const img = cardEl?.querySelector('.poster-img');
        if (img && omdb.Poster && omdb.Poster !== "N/A") {
          // Check if original poster failed
          img.onerror = function() {
            this.src = omdb.Poster;
            this.onerror = null; // Prevent infinite loop
          };
        }
      }
    }

    function renderPosts(list) {
      container.innerHTML = "";
      if (list.length === 0) {
        container.innerHTML = "<p class='text-center text-muted'>No posts found.</p>";
        return;
      }
      
      // Render all cards immediately with JSON posters
      list.forEach(post => {
        const cardElement = createCard(post);
        container.appendChild(cardElement);
      });
      
      // Fetch OMDb data in parallel (only for ratings)
      list.forEach(post => {
        updateCardWithOMDb(post);
      });
    }

    function filterAndRender() {
      const q = searchInput.value.toLowerCase();
      const filtered = allPosts.filter(p => p.heading && p.heading.toLowerCase().includes(q));
      filtered.sort((a,b) => b.id - a.id);
      renderPosts(filtered);
    }

    (async function init() {
      allPosts = await loadPosts();
      filterAndRender();
    })();
    searchInput.oninput = filterAndRender;
  </script>
</body>
</html>
